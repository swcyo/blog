---
title: R到底如何做多组样本均数比较及两两比较？
author: 欧阳松
date: '2022-11-10'
slug: anova
categories:
  - 单因素方差分析
  - anova
  - ANOVA
tags:
  - 多因素方差分析
  - ANOVA
  - 多个样本两两比较
from_Rmd: yes
---

关于多个样本均数的比较，也就是我们说的单因素方差分析（ANOVA）网上有很多帖子，然我对那些方法都是怀疑的，尤其是写到关于多个样本的两两比较用t检验，比如这篇：[使用R语言进行单因素方差分析以及结果可视化](https://mp.weixin.qq.com/s/PDbuql_ANZVu14Sk6VzEEw)

我们可以先复现一下这篇教程的结果。

## 复现公众号教程结果

### 加载包，构建模拟数据


```r
### 加载需要的包
library(ggpubr)
library(rstatix)
### 构建数据
df <- data.frame(a = c(3.53, 4.59, 4.34, 2.66, 3.59, 3.13, 2.64, 2.56, 3.5, 3.25,
  3.3, 4.04, 3.53, 3.56, 3.85, 4.07, 3.52, 3.93, 4.19, 2.96, 1.37, 3.93, 2.33,
  2.98, 4, 3.55, 2.96, 4.3, 4.16, 2.59), b = c(2.42, 3.36, 4.32, 2.34, 2.68, 2.95,
  1.56, 3.11, 1.81, 1.77, 1.98, 2.63, 2.86, 2.93, 2.17, 2.72, 2.65, 2.22, 2.9,
  2.97, 2.36, 2.56, 2.52, 2.27, 2.98, 3.72, 2.8, 3.57, 4.02, 2.31), c = c(2.86,
  2.28, 2.39, 2.28, 2.48, 2.28, 3.21, 2.23, 2.32, 2.68, 2.66, 2.32, 2.61, 3.64,
  2.58, 3.65, 2.66, 3.68, 2.65, 3.02, 3.48, 2.42, 2.41, 2.66, 3.29, 2.7, 3.04,
  2.81, 1.97, 1.68), d = c(0.89, 1.06, 1.08, 1.27, 1.63, 1.89, 1.19, 2.17, 2.28,
  1.72, 1.98, 1.74, 2.16, 3.37, 2.97, 1.69, 0.94, 2.11, 2.81, 2.52, 1.31, 2.51,
  1.88, 1.41, 3.19, 1.92, 2.47, 1.02, 2.1, 3.71))
```

我们看看构建的这个数据的结果，可以看到有a、b、c、d四个组，每组30个数据


|    a|    b|    c|    d|
|----:|----:|----:|----:|
| 3.53| 2.42| 2.86| 0.89|
| 4.59| 3.36| 2.28| 1.06|
| 4.34| 4.32| 2.39| 1.08|
| 2.66| 2.34| 2.28| 1.27|
| 3.59| 2.68| 2.48| 1.63|
| 3.13| 2.95| 2.28| 1.89|
| 2.64| 1.56| 3.21| 1.19|
| 2.56| 3.11| 2.23| 2.17|
| 3.50| 1.81| 2.32| 2.28|
| 3.25| 1.77| 2.68| 1.72|
| 3.30| 1.98| 2.66| 1.98|
| 4.04| 2.63| 2.32| 1.74|
| 3.53| 2.86| 2.61| 2.16|
| 3.56| 2.93| 3.64| 3.37|
| 3.85| 2.17| 2.58| 2.97|
| 4.07| 2.72| 3.65| 1.69|
| 3.52| 2.65| 2.66| 0.94|
| 3.93| 2.22| 3.68| 2.11|
| 4.19| 2.90| 2.65| 2.81|
| 2.96| 2.97| 3.02| 2.52|
| 1.37| 2.36| 3.48| 1.31|
| 3.93| 2.56| 2.42| 2.51|
| 2.33| 2.52| 2.41| 1.88|
| 2.98| 2.27| 2.66| 1.41|
| 4.00| 2.98| 3.29| 3.19|
| 3.55| 3.72| 2.70| 1.92|
| 2.96| 2.80| 3.04| 2.47|
| 4.30| 3.57| 2.81| 1.02|
| 4.16| 4.02| 1.97| 2.10|
| 2.59| 2.31| 1.68| 3.71|

### 数据转换

如果要进行后续分析，需要处理数据，这里使用将tidyr或者tidyverse**将宽数据转化为长数据**。


```r
library(tidyr)
df2 <- df %>%
  pivot_longer(a:d, # 需要转换的变量
               names_to = "group", # 转换后的新变量名称
               values_to = "value") # 转换后的新变量值
```


|group | value|
|:-----|-----:|
|a     |  3.53|
|b     |  2.42|
|c     |  2.86|
|d     |  0.89|
|a     |  4.59|
|b     |  3.36|
|c     |  2.28|
|d     |  1.06|
|a     |  4.34|
|b     |  4.32|
|c     |  2.39|
|d     |  1.08|
|a     |  2.66|
|b     |  2.34|
|c     |  2.28|
|d     |  1.27|
|a     |  3.59|
|b     |  2.68|
|c     |  2.48|
|d     |  1.63|
|a     |  3.13|
|b     |  2.95|
|c     |  2.28|
|d     |  1.89|
|a     |  2.64|
|b     |  1.56|
|c     |  3.21|
|d     |  1.19|
|a     |  2.56|
|b     |  3.11|
|c     |  2.23|
|d     |  2.17|
|a     |  3.50|
|b     |  1.81|
|c     |  2.32|
|d     |  2.28|
|a     |  3.25|
|b     |  1.77|
|c     |  2.68|
|d     |  1.72|
|a     |  3.30|
|b     |  1.98|
|c     |  2.66|
|d     |  1.98|
|a     |  4.04|
|b     |  2.63|
|c     |  2.32|
|d     |  1.74|
|a     |  3.53|
|b     |  2.86|
|c     |  2.61|
|d     |  2.16|
|a     |  3.56|
|b     |  2.93|
|c     |  3.64|
|d     |  3.37|
|a     |  3.85|
|b     |  2.17|
|c     |  2.58|
|d     |  2.97|
|a     |  4.07|
|b     |  2.72|
|c     |  3.65|
|d     |  1.69|
|a     |  3.52|
|b     |  2.65|
|c     |  2.66|
|d     |  0.94|
|a     |  3.93|
|b     |  2.22|
|c     |  3.68|
|d     |  2.11|
|a     |  4.19|
|b     |  2.90|
|c     |  2.65|
|d     |  2.81|
|a     |  2.96|
|b     |  2.97|
|c     |  3.02|
|d     |  2.52|
|a     |  1.37|
|b     |  2.36|
|c     |  3.48|
|d     |  1.31|
|a     |  3.93|
|b     |  2.56|
|c     |  2.42|
|d     |  2.51|
|a     |  2.33|
|b     |  2.52|
|c     |  2.41|
|d     |  1.88|
|a     |  2.98|
|b     |  2.27|
|c     |  2.66|
|d     |  1.41|
|a     |  4.00|
|b     |  2.98|
|c     |  3.29|
|d     |  3.19|
|a     |  3.55|
|b     |  3.72|
|c     |  2.70|
|d     |  1.92|
|a     |  2.96|
|b     |  2.80|
|c     |  3.04|
|d     |  2.47|
|a     |  4.30|
|b     |  3.57|
|c     |  2.81|
|d     |  1.02|
|a     |  4.16|
|b     |  4.02|
|c     |  1.97|
|d     |  2.10|
|a     |  2.59|
|b     |  2.31|
|c     |  1.68|
|d     |  3.71|

### **计算统计检验**

教程里使用的是rstatix包的`anova_test()`来计算统计检验，并使用`add_significance()`函数来将P值转换显著性符号。


```r
# 统计检验
stat.test <- df2 %>%
  anova_test(value ~ group) %>% # 进行t检验
  add_significance() # 增加统计星号
```


|Effect | DFn| DFd|     F|  p|p<.05 |   ges|p.signif |
|:------|---:|---:|-----:|--:|:-----|-----:|:--------|
|group  |   3| 116| 24.88|  0|*     | 0.392|****     |

### **多个均数两两比较**

按照这里的教程，就是简单粗暴的t检验，不过分组统计了


```r
# 统计检验
stat.test <- df2 %>%
  t_test(value ~ group) %>% # 进行t检验
  add_significance() # 增加统计星号
stat.test # 输出结果
```

```
## # A tibble: 6 × 10
##   .y.   group1 group2    n1    n2 statistic    df        p    p.adj p.adj.signif
##   <chr> <chr>  <chr>  <int> <int>     <dbl> <dbl>    <dbl>    <dbl> <chr>       
## 1 value a      b         30    30     4.09   57.3 1.38e- 4 3.09e- 4 ***         
## 2 value a      c         30    30     4.61   51.7 2.71e- 5 1.36e- 4 ***         
## 3 value a      d         30    30     7.76   57.9 1.58e-10 9.48e-10 ****        
## 4 value b      c         30    30     0.117  54.7 9.07e- 1 9.07e- 1 ns          
## 5 value b      d         30    30     4.18   56.6 1.03e- 4 3.09e- 4 ***         
## 6 value c      d         30    30     4.47   50.5 4.46e- 5 1.78e- 4 ***
```


|.y.   |group1 |group2 | n1| n2| statistic|    df|      p|  p.adj|p.adj.signif |
|:-----|:------|:------|--:|--:|---------:|-----:|------:|------:|:------------|
|value |a      |b      | 30| 30|    4.0859| 57.26| 0.0001| 0.0003|***          |
|value |a      |c      | 30| 30|    4.6054| 51.72| 0.0000| 0.0001|***          |
|value |a      |d      | 30| 30|    7.7571| 57.89| 0.0000| 0.0000|****         |
|value |b      |c      | 30| 30|    0.1174| 54.73| 0.9070| 0.9070|ns           |
|value |b      |d      | 30| 30|    4.1774| 56.63| 0.0001| 0.0003|***          |
|value |c      |d      | 30| 30|    4.4684| 50.50| 0.0000| 0.0002|***          |

### **可视化两两比较结果**

使用**ggpubr**进行绘图，这里我们可以在原教程上再美化美化，另外再添加一个整体的anova结果，见Figure \@ref(fig:fig1)所示。


```r
## 绘制带P值的箱型图
bxp <- ggboxplot(df2, x = "group", y = "value", 
                 color = "group",
                 palette = 'lancet',add = 'dotplot',
                 ggtheme = theme_bw(),legend='none')
## 设置统计检验的分组和坐标位置
stat.test <- stat.test %>% 
  add_xy_position(x = "group")

bxp + stat_pvalue_manual(stat.test, label = "p.adj.signif", 
                         tip.length = 0.01)+ ## 手动添加p值
  stat_compare_means(method = 'anova') ## 添加整体anova的结果，这更科学。
```

<div class="figure" style="text-align: center">
<img src="/figures/course/2022-11-10-anova/anova/fig1-1.png" alt="多个样本的比较"  />
<p class="caption">多个样本的比较</p>
</div>

**然而**，我是**一直不认同**这种方法的，主要有两个弊端：

1.  没有考虑数据的正态性检验和方差齐性检验

2.  事后检验的两两比较真的可以直接用t检验？

------------------------------------------------------------------------

关于单因素方差分析，网上的那些分析方法和结果都大差不差，这方面我没有太多疑虑，基本是一个anova函数就可以完成。

虽然我不是专业的统计学人士，但也知道要事先经过正态性检验和方差齐性检验，然后选择合适的检验方法（到底是非参数检验和参数检验），这些许多教程并没有提及，而是选择了最简单的方法，两位关于两两比较的事情了，几乎所有的教程用的两两比较都是用t检验，且不说这种方法是否科学，在我学的课程里，事后检验是有很多种情况的，统一用t检验或者非参数检验确实可以得到结果，但是这种结果真的科学吗？？

我们可以回顾一下ANOVA和事后检验的步骤流程：

1.  首先进行正态性检验，而且是每一个组的正态性检验，而不是整体的正态性检验，如果结果符合正态分布(p\>0.05)，那么选择参数检验，否则只能非参数检验。

2.  进行方差齐性检验，只有方差具有齐性时(p\>0.05)，选择参数检验，否则只能非参数检验

3.  事后检验的方法和校正，SPSS有LSD法和Tukey等方法，R语言一般使用Tukey检验（仅限等样本量、方差齐）或Games-Howell检验（方差不齐）

------------------------------------------------------------------------

因此，我觉得就应该按部就班的分析，必须要先评估是否具有正态分布和方差齐性这两个条件，参照《R语言医学数据分析实践》这本书的第5章5.3.3和5.3.4的内容，我们分别进行多样本的组间差异比较。

## 单因素方差分析

### 正态性检验

如果想知道abcd四组的各值是否存在差异，首先检查**各组**数据的正态性（注意不是~~整体的正态性~~）。

这里我们使用基础包的`tapply()`函数可以分组检验，正态性检验方法是`shapiro.test`。


```r
tapply(df2$value, df2$group, shapiro.test  ## 正态性检验的方法
)  ## 值在前，组在后
```

```
## $a
## 
## 	Shapiro-Wilk normality test
## 
## data:  X[[i]]
## W = 0.95, p-value = 0.2
## 
## 
## $b
## 
## 	Shapiro-Wilk normality test
## 
## data:  X[[i]]
## W = 0.97, p-value = 0.5
## 
## 
## $c
## 
## 	Shapiro-Wilk normality test
## 
## data:  X[[i]]
## W = 0.94, p-value = 0.1
## 
## 
## $d
## 
## 	Shapiro-Wilk normality test
## 
## data:  X[[i]]
## W = 0.96, p-value = 0.3
```

我们可以看到各组的p值均是大于0.05，也就是说符合正态性分布。可以用QQ图看一下各组的分布，间Figure \@ref(fig:fig2)所示。


```r
ggqqplot(df2, "value", facet.by = "group")
```

<div class="figure" style="text-align: center">
<img src="/figures/course/2022-11-10-anova/anova/fig2-1.png" alt="各组QQ图分布"  />
<p class="caption">各组QQ图分布</p>
</div>

> -   如果结果不符合正态分布的话，那么方差齐性检验也不用分析了，直接使用非参数检验。

ps: 如果只想知道整体的正态性检验，代码是


```r
shapiro.test(df2$value)
```

```
## 
## 	Shapiro-Wilk normality test
## 
## data:  df2$value
## W = 0.99, p-value = 0.3
```

### 方差齐性检验

有`bartlett.test`和`leveneTest`两种方法，按照书上的说法是**Bartlett检验对数据的正态性非常敏感**，而**Levene检验是一种非参数检验，其适应范围更广**。Levene检验可以用**car**包的函数`leveneTest()`进行。

#### **Bartlett检验（正态分布时）**

直接使用基础包计算，不需要安装其他包。


```r
bartlett.test(value ~ group, data = df2)
```

```
## 
## 	Bartlett test of homogeneity of variances
## 
## data:  value by group
## Bartlett's K-squared = 5.2, df = 3, p-value = 0.2
```

#### Levene检验（广泛情况）

需要提取安装**car**这个包，另外，需要将分组转换为因子形式


```r
library(car)
```

```
## Loading required package: carData
```

```r
df2$group <- as.factor(df2$group)
leveneTest(value ~ group, data = df2)
```

```
## Levene's Test for Homogeneity of Variance (center = median)
##        Df F value Pr(>F)
## group   3    1.49   0.22
##       116
```

可以看到两种方法的结果的p值都\>0.05，也就是说都符合方差齐性分析，这时我们就可以进行方差分析的正式检验了，我们可以使用基础包的aov函数就行方差分析模型构建。


```r
aov <- aov(value ~ group, data = df2)
summary(aov)
```

```
##              Df Sum Sq Mean Sq F value  Pr(>F)    
## group         3   32.2   10.72    24.9 1.7e-12 ***
## Residuals   116   50.0    0.43                    
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
```

上面的两个函数，`aov()`函数建立了方差分析模型，`summar`函数得到了结果。结果表明，不同分组之间的结果有统计学医院。aov

### 事后检验

由于方差具有齐性，我们可以使用基础包的`TukeyHSD()`函数进行两两比较。


```r
TukeyHSD(aov)
```

```
##   Tukey multiple comparisons of means
##     95% family-wise confidence level
## 
## Fit: aov(formula = value ~ group, data = df2)
## 
## $group
##         diff     lwr     upr  p adj
## b-a -0.71500 -1.1567 -0.2733 0.0003
## c-a -0.73233 -1.1741 -0.2906 0.0002
## d-a -1.46400 -1.9057 -1.0223 0.0000
## c-b -0.01733 -0.4591  0.4244 0.9996
## d-b -0.74900 -1.1907 -0.3073 0.0001
## d-c -0.73167 -1.1734 -0.2899 0.0002
```

可以看到，出来c-b两组外，其余均有显著意义。


|    |    diff|     lwr|     upr|  p adj|
|:---|-------:|-------:|-------:|------:|
|b-a | -0.7150| -1.1567| -0.2733| 0.0003|
|c-a | -0.7323| -1.1741| -0.2906| 0.0002|
|d-a | -1.4640| -1.9057| -1.0223| 0.0000|
|c-b | -0.0173| -0.4591|  0.4244| 0.9996|
|d-b | -0.7490| -1.1907| -0.3073| 0.0001|
|d-c | -0.7317| -1.1734| -0.2899| 0.0002|

另外，进行组建的两两比较的方法还有很多，可以进行校正，比如Bonferroni法、Holm法等，还有针对方差不齐时的Games-Howell法等等。这个后面的教程说。


```r
pairwise.t.test(df2$value, df2$group, p.adjust.method = "bonferroni")
```

```
## 
## 	Pairwise comparisons using t tests with pooled SD 
## 
## data:  df2$value and df2$group 
## 
##   a     b     c    
## b 3e-04 -     -    
## c 2e-04 1     -    
## d 2e-13 1e-04 2e-04
## 
## P value adjustment method: bonferroni
```

```r
## 从函数可以看出用的是配对t检验。
```


|   |     a|     b|     c|
|:--|-----:|-----:|-----:|
|b  | 3e-04|    NA|    NA|
|c  | 2e-04| 1e+00|    NA|
|d  | 0e+00| 1e-04| 2e-04|

得到的结果与Tukey法接近。

------------------------------------------------------------------------

我们当然也可以使用SPSS，或者jamovi复现结果，如果偷懒的话，其实用仙桃学术进行分析。或者SPSSPRO或SPSSAU等进行SPSS的很无脑的操作
